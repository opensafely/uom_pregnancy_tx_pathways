---
title: "Investigation of Pregnancy Code Usage in Primary Care in England"
subtitle: "Short Data Report"
authors:
  - name: Rose Higgins
    affiliations:
      name: "University of Oxford"
      department: "Nuffield Department of Primary Care Health Sciences"
      group: "Bennett Institute for Applied Data Science"
    orcid: 0000-0002-5295-4370
    email: rose.higgins@phc.ox.ac.uk
  - name: Milan Wiedemann
    affiliations:
      name: "University of Oxford"
      department: "Nuffield Department of Primary Care Health Sciences"
      group: "Bennett Institute for Applied Data Science"
    orcid: 0000-0003-1991-282X
    email: milan.wiedemann@phc.ox.ac.uk
  - name: Louis Fischer
    affiliations:
      name: "University of Oxford"
      department: "Nuffield Department of Primary Care Health Sciences"
      group: "Bennett Institute for Applied Data Science"
    orcid: 0000-0002-0295-3812
    email: louis.fisher@phc.ox.ac.uk
  - name: Helen Curtis 
    affiliations:
      name: "University of Oxford"
      department: "Nuffield Department of Primary Care Health Sciences"
      group: "Bennett Institute for Applied Data Science"
    orcid: 0000-0003-3429-9576
    email: helen.curtis@phc.ox.ac.uk
bibliography: references.bib
editor_options: 
  chunk_output_type: console
---

```{r load-pkgs}
#| include: false

library(here)
library(fs)
library(tidyverse)
library(patchwork)
library(ggrepel)
library(gt)
library(plotly)
```

```{r}
#| label: load-data
#| include: false
#| cache: true

load(here("sdr", "data", "snomed_code_usage.rda"))
load(here("sdr", "data", "snomed_code_dict.rda"))

used_snomed_concept_ids <- unique(snomed_code_usage$snomed_concept_id)

pregnancy_codelists_paths <- dir_ls(
  here("codelists"),
  glob = "*user-VickiPalin-pregnancy*.csv$"
)

pregnancy_codelists <- pregnancy_codelists_paths |>
  map(read_csv, col_types = list(code = "c")) %>%
  bind_rows(.id = "codelist") |>
  mutate(codelist = str_extract(codelist, "(?<=user-VickiPalin-)\\w+"))

pregnancy_codelists_selected <- pregnancy_codelists |>
  filter(
    codelist %in% c(
      "pregnancy_delivery_snomed_reviewed_2",
      "pregnancy_postdel_antenatal_snomed",
      "pregnancy_antenatal_snomed"
      )
    )

snomed_code_dict_short <- snomed_code_dict |> 
  group_by(snomed_concept_id) |> 
  slice_max(start_date) |> 
  mutate(snomed_concept_id_desc = paste0(snomed_concept_id, ": ", description)) |> 
  select(snomed_concept_id, snomed_concept_id_desc) |> 
  ungroup()
```

```{r load-funs}
#| label: load-funs
#| include: false

source(here("sdr", "scripts", "visualise_code_usage.R"))
```

# Introduction

Identifying pregnancy in primary care electronic healthcare records is difficult.
We aim to explore publicly available data about code usage in primary care in England to understand how pregnancy related events are recorded since 2011.
This report will focus on:

1. **Changes and variation in code usage since 2011**
2. **Which codes describe most of the pregnancy related clinical events since 2011**

# Methods

## Codelists

We converted Read Codes used by @Minassian2019 to SNOMED CT Codes (see <https://github.com/opensafely/uom_pregnancy_tx_pathways>).
In this report we analyse the code usage of the following three codelists:

### [Antenatal](https://www.opencodelists.org/codelist/user/VickiPalin/pregnancy_antenatal_snomed/61667fb8/)

```{r}
#| label: tbl-pregnancy_antenatal_snomed
#| tbl-cap: 'pregnancy_antenatal_snomed codelist (Version 61667fb8)'

pregnancy_codelists_selected |>
  filter(codelist == "pregnancy_antenatal_snomed") |>
  select(code, term) |>
  gt() |>
  cols_label(
    code = "SNOMED Code",
    term = "Description",
  ) |>
  cols_width(
    code ~ px(180),
    term ~ px(550)
  ) |>
  opt_interactive(
    use_filters = TRUE,
    use_highlight = TRUE,
    use_compact_mode = TRUE,
    use_resizers= TRUE,
    use_page_size_select = TRUE
    )

```

### [Delivery](https://www.opencodelists.org/codelist/user/VickiPalin/pregnancy_delivery_snomed_reviewed_2/39a121e3/)

```{r}
#| label: tbl-pregnancy_delivery_snomed_reviewed_2
#| tbl-cap: 'pregnancy_delivery_snomed_reviewed_2 codelist (Version 39a121e3)'

pregnancy_codelists_selected |>
  filter(codelist == "pregnancy_delivery_snomed_reviewed_2") |>
  select(code, term) |>
  gt() |>
  cols_label(
    code = "SNOMED Code",
    term = "Description",
  ) |>
  cols_width(
    code ~ px(180),
    term ~ px(550)
  ) |>
  opt_interactive(
    use_filters = TRUE,
    use_highlight = TRUE,
    use_compact_mode = TRUE,
    use_resizers= TRUE,
    use_page_size_select = TRUE
    )

```

### [Post-delivery Antenatal](https://www.opencodelists.org/codelist/user/VickiPalin/pregnancy_postdel_antenatal_snomed/22287ec9/)

```{r}
#| label: tbl-pregnancy_postdel_antenatal_snomed
#| tbl-cap: 'pregnancy_postdel_antenatal_snomed codelist (Version 39a121e3)'

pregnancy_codelists_selected |>
  filter(codelist == "pregnancy_delivery_snomed_reviewed_2") |>
  select(code, term) |>
  gt() |>
  cols_label(
    code = "SNOMED Code",
    term = "Description",
  ) |>
  cols_width(
    code ~ px(180),
    term ~ px(550)
  ) |>
  opt_interactive(
    use_filters = TRUE,
    use_highlight = TRUE,
    use_compact_mode = TRUE,
    use_resizers= TRUE,
    use_page_size_select = TRUE
    )

```

## Data source

We used publicly available the SNOMED Code Usage in Primary Care data [@NHSDigital2024] to investigate the code usage of pregnancy related codes between 1st August 2011 to 31 July 2023.

## Data analyses

We investigated code usage with the following 5 metrics across three overarching areas: (1) Overall code usage, (2) Change detection and variation, (3) Changes in clinical guidance.
Each metric is reported for latest year (`r format(max(snomed_code_usage$start_date), format="%d %B %Y")` to `r format(max(snomed_code_usage$end_date), format="%d %B %Y")`) and over whole period separately (`r format(min(snomed_code_usage$start_date), format="%d %B %Y")` to `r format(max(snomed_code_usage$end_date), format="%d %B %Y")`).
For each code we also report when the code first and last time a code appeared in the data.

### Overall code usage

1. Top 10 codes and their usage for each codelist
2. How many codes are driving the majority of the clinical activity (80%)

### Change detection and variation

1. To detect changes and variation we focused on codes which contributed to high volumes (a code contirbuted to at least 5% of the total usage in at least on yearly interval) and
   change drastically from year to year (more than 10% change) or from the first occurence to the last (more than 30% change).

### Changes in clinical guidance

We reviewed how changes in clinical guidance for pregnancy correlated with:

4. Newly introduced clinical codes that drive a large part of the clinical activity (within the top 5 codes) in each codelist
5. Reliable changes in code usage

# Results

## Overall code usage

### Antenatal

```{r}
#| label: code-usage-pregnancy_antenatal_snomed
#| include: false
#| cache: false

# Select data for one codelist
delivery_codelist <- pregnancy_codelists |> 
  filter(codelist == "pregnancy_antenatal_snomed")

# Get list of codes from codelist that were not found in GP records
delivery_unused_codes <- delivery_codelist |> 
  filter(!code %in% used_snomed_concept_ids) |> 
  pull(code)

# Select data for all codes from codelist that were found in GP records
delivery_selected_snomed_code_usage <- snomed_code_usage |>
  filter(snomed_concept_id %in% delivery_codelist$code)

# Get list of 5 most used codes from codelist
delivery_selected_top_10_codes <- delivery_selected_snomed_code_usage |>
  select(snomed_concept_id, usage) |>
  group_by(snomed_concept_id) |>
  mutate(usage_sum = sum(usage)) |>
  ungroup() |>
  select(-usage) |>
  distinct() |>
  slice_max(usage_sum, n = 10) |>
  pull(snomed_concept_id)

tbl_delivery_selected_snomed_code_usage <- delivery_selected_snomed_code_usage |>
  filter(!snomed_concept_id %in% delivery_unused_codes) |>
  left_join(snomed_code_dict) |>
  select(start_date, end_date, snomed_concept_id, description, usage) |>
  group_by(snomed_concept_id) |>
  mutate(
    sum_usage_total = sum(usage, na.rm = TRUE),
    min_start_date = min(start_date, na.rm = TRUE),
    max_end_date = max(end_date, na.rm = TRUE)
  ) |>
  filter(start_date == "2022-08-01") |>
  select(start_date, snomed_concept_id, description, sum_usage_22to23 = usage, sum_usage_total, min_start_date, max_end_date) |>
  ungroup() |>
  mutate(
    pct_usage_total = sum_usage_total / sum(sum_usage_total),
    pct_usage_22to23 = sum_usage_22to23 / sum(sum_usage_22to23),
    active_date_range = paste0(year(min_start_date), " to ", year(max_end_date))
  ) |>
  select(snomed_concept_id, description, active_date_range, sum_usage_22to23, pct_usage_22to23, sum_usage_total, pct_usage_total)

```

```{r}
#| label: calc-fig-pregnancy_antenatal_snomed
#| include: false
#| cache: false

delivery_selected_snomed_code_usage <- delivery_selected_snomed_code_usage |>
  left_join(snomed_code_dict_short) |> 
  group_by(end_date) |> 
  mutate(usage_codelist = sum(usage, na.rm = TRUE)) |> 
  ungroup()

plot_sum_codelist <- delivery_selected_snomed_code_usage |> 
  plot_code_usage(
    date_variable = end_date,
    code_usage_count = usage_codelist
    )

plot_top_codelist <- delivery_selected_snomed_code_usage |> 
  filter(snomed_concept_id %in% delivery_selected_top_10_codes) |> 
  plot_code_usage(
    date = end_date,
    code_usage = usage,
    colour = snomed_concept_id_desc
    ) +
  guides(color = "none")

```

```{r}
#| label: fig1-pregnancy_antenatal_snomed
#| fig-cap: "Figure 1. Overall trend of code usage of 'pregnancy_antenatal_snomed' codelist for each year from 1st August 2011 to 31 July 2023. Each point represents the end date of a yearly interval." 
#| fig-width: 8
#| fig-height: 4

plotly::ggplotly(plot_sum_codelist)
```

```{r}
#| label: fig2-pregnancy_antenatal_snomed
#| fig-cap: "Figure 2. Trends of the 10 most used codes of 'pregnancy_antenatal_snomed' codelist from 1st August 2011 to 31 July 2023. Each point represents the end date of a yearly interval." 
#| fig-width: 8
#| fig-height: 4

plotly::ggplotly(plot_top_codelist)
```

#### 1st Aug 2011 to 31 Jul 2023

```{r}
#| label: tbl-used-codes-pregnancy_antenatal_snomed-1
#| tbl-cap: Counts of used codes from 'pregnancy_antenatal_snomed' between 1st Aug 2011 and 31 Jul 2023

tbl_delivery_selected_snomed_code_usage |>
  select(
    snomed_concept_id, description, active_date_range,
    sum_usage_total, pct_usage_total) |>
  arrange(desc(sum_usage_total)) |>
  gt() |>
  cols_label(
    snomed_concept_id = "SNOMED Code",
    description = "Description",
    active_date_range = "Codes active",
    sum_usage_total = "Count",
    pct_usage_total = "%"
  ) |>
  cols_width(
    snomed_concept_id ~ px(160),
    description ~ px(280),
    active_date_range ~ px(125),
    sum_usage_total ~ px(100),
    pct_usage_total ~ px(65)
  ) |>
  fmt_percent(
    columns = pct_usage_total,
    decimals = 1
  ) |>
  opt_interactive(
    use_filters = TRUE,
    use_highlight = TRUE,
    use_compact_mode = TRUE,
    use_resizers= TRUE,
    use_page_size_select = TRUE
    )

```

#### 1st Aug 2022 to 31 Jul 2023

```{r}
#| label: tbl-used-codes-pregnancy_antenatal_snomed-2
#| tbl-cap: Counts of used codes from 'pregnancy_antenatal_snomed' between 1st Aug 2022 and 31 Jul 2023

tbl_delivery_selected_snomed_code_usage |>
  select(
    snomed_concept_id, description, active_date_range,
    sum_usage_22to23, pct_usage_22to23) |>
  arrange(desc(sum_usage_22to23)) |>
  gt() |>
  cols_label(
    snomed_concept_id = "SNOMED Code",
    description = "Description",
    active_date_range = "Codes active",
    sum_usage_22to23 = "Count",
    pct_usage_22to23 = "%"
  ) |>
  cols_width(
    snomed_concept_id ~ px(160),
    description ~ px(280),
    active_date_range ~ px(125),
    sum_usage_22to23 ~ px(100),
    pct_usage_22to23 ~ px(65)
  ) |>
  fmt_percent(
    columns = pct_usage_22to23,
    decimals = 1
  ) |>
  opt_interactive(
    use_filters = TRUE,
    use_highlight = TRUE,
    use_compact_mode = TRUE,
    use_resizers= TRUE,
    use_page_size_select = TRUE
    )

```

### Delivery

```{r}
#| label: code-usage-pregnancy_delivery_snomed_reviewed_2
#| include: false
#| cache: false

# Select data for one codelist
delivery_codelist <- pregnancy_codelists |> 
  filter(codelist == "pregnancy_delivery_snomed_reviewed_2")

# Get list of codes from codelist that were not found in GP records
delivery_unused_codes <- delivery_codelist |> 
  filter(!code %in% used_snomed_concept_ids) |> 
  pull(code)

# Select data for all codes from codelist that were found in GP records
delivery_selected_snomed_code_usage <- snomed_code_usage |>
  filter(snomed_concept_id %in% delivery_codelist$code)

# Get list of 5 most used codes from codelist
delivery_selected_top_10_codes <- delivery_selected_snomed_code_usage |>
  select(snomed_concept_id, usage) |>
  group_by(snomed_concept_id) |>
  mutate(usage_sum = sum(usage)) |>
  ungroup() |>
  select(-usage) |>
  distinct() |>
  slice_max(usage_sum, n = 10) |>
  pull(snomed_concept_id)

tbl_delivery_selected_snomed_code_usage <- delivery_selected_snomed_code_usage |>
  filter(!snomed_concept_id %in% delivery_unused_codes) |>
  left_join(snomed_code_dict) |>
  select(start_date, end_date, snomed_concept_id, description, usage) |>
  group_by(snomed_concept_id) |>
  mutate(
    sum_usage_total = sum(usage, na.rm = TRUE),
    min_start_date = min(start_date, na.rm = TRUE),
    max_end_date = max(end_date, na.rm = TRUE)
  ) |>
  filter(start_date == "2022-08-01") |>
  select(start_date, snomed_concept_id, description, sum_usage_22to23 = usage, sum_usage_total, min_start_date, max_end_date) |>
  ungroup() |>
  mutate(
    pct_usage_total = sum_usage_total / sum(sum_usage_total),
    pct_usage_22to23 = sum_usage_22to23 / sum(sum_usage_22to23),
    active_date_range = paste0(year(min_start_date), " to ", year(max_end_date))
  ) |>
  select(snomed_concept_id, description, active_date_range, sum_usage_22to23, pct_usage_22to23, sum_usage_total, pct_usage_total)

```

```{r}
#| label: calc-fig-pregnancy_delivery_snomed_reviewed_2
#| include: false
#| cache: false

delivery_selected_snomed_code_usage <- delivery_selected_snomed_code_usage |> 
  left_join(snomed_code_dict_short) |> 
  group_by(end_date) |> 
  mutate(usage_codelist = sum(usage, na.rm = TRUE)) |> 
  ungroup()

plot_sum_codelist <- delivery_selected_snomed_code_usage |> 
  plot_code_usage(
    date_variable = end_date,
    code_usage_count = usage_codelist
    )

plot_top_codelist <- delivery_selected_snomed_code_usage |> 
  filter(snomed_concept_id %in% delivery_selected_top_10_codes) |> 
  plot_code_usage(
    date = end_date,
    code_usage = usage,
    colour = snomed_concept_id_desc
    ) + 
  guides(color = "none")

```


```{r}
#| label: fig1-pregnancy_delivery_snomed_reviewed_2
#| fig-cap: "Figure 1. Overall trend of code usage of 'pregnancy_delivery_snomed_reviewed_2' codelist from 1st August 2011 to 31 July 2023. Each point represents the end date of a yearly interval." 
#| fig-width: 8
#| fig-height: 4

plotly::ggplotly(plot_sum_codelist)
```

```{r}
#| label: fig2-pregnancy_delivery_snomed_reviewed_2
#| fig-cap: "Figure 2. Trends of the 10 most used codes of 'pregnancy_delivery_snomed_reviewed_2' codelist from 1st August 2011 to 31 July 2022. Each point represents the end date of a yearly interval." 
#| fig-width: 8
#| fig-height: 4

plotly::ggplotly(plot_top_codelist)
```

#### 1st Aug 2011 to 31 Jul 2023

```{r}
#| label: tbl-used-codes-delivery-1
#| tbl-cap: Counts of used codes from 'pregnancy_delivery_snomed_reviewed_2' between 1st Aug 2011 and 31 Jul 2023

tbl_delivery_selected_snomed_code_usage |>
  select(
    snomed_concept_id, description, active_date_range,
    sum_usage_total, pct_usage_total) |>
  arrange(desc(sum_usage_total)) |>
  gt() |>
  cols_label(
    snomed_concept_id = "SNOMED Code",
    description = "Description",
    active_date_range = "Codes active",
    sum_usage_total = "Count",
    pct_usage_total = "%"
  ) |>
  cols_width(
    snomed_concept_id ~ px(160),
    description ~ px(280),
    active_date_range ~ px(125),
    sum_usage_total ~ px(100),
    pct_usage_total ~ px(65)
  ) |>
  fmt_percent(
    columns = pct_usage_total,
    decimals = 1
  ) |>
  opt_interactive(
    use_filters = TRUE,
    use_highlight = TRUE,
    use_compact_mode = TRUE,
    use_resizers= TRUE,
    use_page_size_select = TRUE
    )

```

#### 1st Aug 2022 to 31 Jul 2023

```{r}
#| label: tbl-used-codes-delivery-2
#| tbl-cap: Counts of used codes from 'pregnancy_delivery_snomed_reviewed_2' between 1st Aug 2022 and 31 Jul 2023

tbl_delivery_selected_snomed_code_usage |>
  select(
    snomed_concept_id, description, active_date_range,
    sum_usage_22to23, pct_usage_22to23) |>
  arrange(desc(sum_usage_22to23)) |>
  gt() |>
  cols_label(
    snomed_concept_id = "SNOMED Code",
    description = "Description",
    active_date_range = "Codes active",
    sum_usage_22to23 = "Count",
    pct_usage_22to23 = "%"
  ) |>
  cols_width(
    snomed_concept_id ~ px(160),
    description ~ px(280),
    active_date_range ~ px(125),
    sum_usage_22to23 ~ px(100),
    pct_usage_22to23 ~ px(65)
  ) |>
  fmt_percent(
    columns = pct_usage_22to23,
    decimals = 1
  ) |>
  opt_interactive(
    use_filters = TRUE,
    use_highlight = TRUE,
    use_compact_mode = TRUE,
    use_resizers= TRUE,
    use_page_size_select = TRUE
    )

```

### Post-delivery Antenatal 

```{r}
#| label: code-usage-pregnancy_postdel_antenatal_snomed
#| include: false
#| cache: false

# Select data for one codelist
delivery_codelist <- pregnancy_codelists |> 
  filter(codelist == "pregnancy_postdel_antenatal_snomed")

# Get list of codes from codelist that were not found in GP records
delivery_unused_codes <- delivery_codelist |> 
  filter(!code %in% used_snomed_concept_ids) |> 
  pull(code)

# Select data for all codes from codelist that were found in GP records
delivery_selected_snomed_code_usage <- snomed_code_usage |>
  filter(snomed_concept_id %in% delivery_codelist$code)

# Get list of 5 most used codes from codelist
delivery_selected_top_10_codes <- delivery_selected_snomed_code_usage |>
  select(snomed_concept_id, usage) |>
  group_by(snomed_concept_id) |>
  mutate(usage_sum = sum(usage)) |>
  ungroup() |>
  select(-usage) |>
  distinct() |>
  slice_max(usage_sum, n = 10) |>
  pull(snomed_concept_id)

tbl_delivery_selected_snomed_code_usage <- delivery_selected_snomed_code_usage |>
  filter(!snomed_concept_id %in% delivery_unused_codes) |>
  left_join(snomed_code_dict) |>
  select(start_date, end_date, snomed_concept_id, description, usage) |>
  group_by(snomed_concept_id) |>
  mutate(
    sum_usage_total = sum(usage, na.rm = TRUE),
    min_start_date = min(start_date, na.rm = TRUE),
    max_end_date = max(end_date, na.rm = TRUE)
  ) |>
  filter(start_date == "2022-08-01") |>
  select(start_date, snomed_concept_id, description, sum_usage_22to23 = usage, sum_usage_total, min_start_date, max_end_date) |>
  ungroup() |>
  mutate(
    pct_usage_total = sum_usage_total / sum(sum_usage_total),
    pct_usage_22to23 = sum_usage_22to23 / sum(sum_usage_22to23),
    active_date_range = paste0(year(min_start_date), " to ", year(max_end_date))
  ) |>
  select(snomed_concept_id, description, active_date_range, sum_usage_22to23, pct_usage_22to23, sum_usage_total, pct_usage_total)

```

```{r}
#| label: calc-fig-pregnancy_postdel_antenatal_snomed
#| include: false
#| cache: false

delivery_selected_snomed_code_usage <- delivery_selected_snomed_code_usage |> 
  left_join(snomed_code_dict_short) |> 
  group_by(end_date) |> 
  mutate(usage_codelist = sum(usage, na.rm = TRUE)) |> 
  ungroup()

plot_sum_codelist <- delivery_selected_snomed_code_usage |> 
  plot_code_usage(
    date_variable = end_date,
    code_usage_count = usage_codelist
    )

plot_top_codelist <- delivery_selected_snomed_code_usage |> 
  filter(snomed_concept_id %in% delivery_selected_top_10_codes) |> 
  plot_code_usage(
    date = end_date,
    code_usage = usage,
    colour = snomed_concept_id_desc
    ) + 
  guides(color = "none")

```


```{r}
#| label: fig1-pregnancy_postdel_antenatal_snomed
#| fig-cap: "Figure 1. Overall trend of code usage of 'pregnancy_postdel_antenatal_snomed' codelist from 1st August 2011 to 31 July 2023. Each point represents the end date of a yearly interval." 
#| fig-width: 8
#| fig-height: 4

plotly::ggplotly(plot_sum_codelist)
```

```{r}
#| label: fig2-pregnancy_postdel_antenatal_snomed
#| fig-cap: "Figure 2. Trends of the 10 most used codes of 'pregnancy_postdel_antenatal_snomed' codelist from 1st August 2011 to 31 July 2022. Each point represents the end date of a yearly interval." 
#| fig-width: 8
#| fig-height: 4

plotly::ggplotly(plot_top_codelist)
```

#### 1st Aug 2011 to 31 Jul 2023

```{r}
#| label: tbl-used-codes-pregnancy_postdel_antenatal_snomed-1
#| tbl-cap: Counts of used codes from 'pregnancy_postdel_antenatal_snomed' between 1st Aug 2011 and 31 Jul 2023

tbl_delivery_selected_snomed_code_usage |>
  select(
    snomed_concept_id, description, active_date_range,
    sum_usage_total, pct_usage_total) |>
  arrange(desc(sum_usage_total)) |>
  gt() |>
  cols_label(
    snomed_concept_id = "SNOMED Code",
    description = "Description",
    active_date_range = "Codes active",
    sum_usage_total = "Count",
    pct_usage_total = "%"
  ) |>
  cols_width(
    snomed_concept_id ~ px(160),
    description ~ px(280),
    active_date_range ~ px(125),
    sum_usage_total ~ px(100),
    pct_usage_total ~ px(65)
  ) |>
  fmt_percent(
    columns = pct_usage_total,
    decimals = 1
  ) |>
  opt_interactive(
    use_filters = TRUE,
    use_highlight = TRUE,
    use_compact_mode = TRUE,
    use_resizers= TRUE,
    use_page_size_select = TRUE
    )

```

#### 1st Aug 2022 to 31 Jul 2023

```{r}
#| label: tbl-used-codes-pregnancy_postdel_antenatal_snomed-2
#| tbl-cap: Counts of used codes from 'pregnancy_postdel_antenatal_snomed' between 1st Aug 2022 and 31 Jul 2023

tbl_delivery_selected_snomed_code_usage |>
  select(
    snomed_concept_id, description, active_date_range,
    sum_usage_22to23, pct_usage_22to23) |>
  arrange(desc(sum_usage_22to23)) |>
  gt() |>
  cols_label(
    snomed_concept_id = "SNOMED Code",
    description = "Description",
    active_date_range = "Codes active",
    sum_usage_22to23 = "Count",
    pct_usage_22to23 = "%"
  ) |>
  cols_width(
    snomed_concept_id ~ px(160),
    description ~ px(280),
    active_date_range ~ px(125),
    sum_usage_22to23 ~ px(100),
    pct_usage_22to23 ~ px(65)
  ) |>
  fmt_percent(
    columns = pct_usage_22to23,
    decimals = 1
  ) |>
  opt_interactive(
    use_filters = TRUE,
    use_highlight = TRUE,
    use_compact_mode = TRUE,
    use_resizers= TRUE,
    use_page_size_select = TRUE
    )

```

## Change detection and variation

### Antenatal

```{r}
#| label: change1
#| tbl-cap: Codes from 'pregnancy_antenatal_snomed' with detected changes between 1st Aug 2011 and 31 Jul 2023


# Select data for one codelist
selected_codelist <- pregnancy_codelists |> 
  filter(codelist == "pregnancy_antenatal_snomed")

# Get list of codes from codelist that were not found in GP records
selected_unused_codes <- selected_codelist |> 
  filter(!code %in% used_snomed_concept_ids) |> 
  pull(code)

# Select data for all codes from codelist that were found in GP records
selected_snomed_code_usage <- snomed_code_usage |>
  filter(snomed_concept_id %in% selected_codelist$code)

selected_snomed_code_usage_earliest <- selected_snomed_code_usage |>
  select(start_date, snomed_concept_id, usage) |> 
  slice_min(start_date) |> 
  select(snomed_concept_id, earliest_usage = usage)

selected_snomed_code_latests <- selected_snomed_code_usage |>
  select(start_date, snomed_concept_id, usage) |> 
  slice_max(start_date) |> 
  select(snomed_concept_id, latests_usage = usage)

change_selected_snomed_code_usage <- selected_snomed_code_usage |>
  left_join(selected_snomed_code_usage_earliest) |> 
  left_join(selected_snomed_code_latests) |>
  arrange(snomed_concept_id, start_date) |>
  group_by(start_date) |>
  mutate(usage_codelist_sum_yearly = sum(usage, na.rm = TRUE)) |>
  ungroup() |>
  group_by(snomed_concept_id) |>
  mutate(
    usage_codelist_yearly_pct = usage / usage_codelist_sum_yearly,
    usage_codelist_max_yearly_pct = max(usage_codelist_yearly_pct, na.rm = TRUE),
    usage_code_change_yearly = usage - lag(usage),
    usage_code_change_yearly_pct = usage_code_change_yearly / usage,
    usage_code_max_change_yearly_pct = max(usage_code_change_yearly_pct, na.rm = TRUE),
    usage_code_startend_change_pct = latests_usage / earliest_usage
  ) |>
  mutate(
    crit_yearly_volume = usage_codelist_max_yearly_pct > .05,
    crit_yearly_change = (usage_code_max_change_yearly_pct > .1) | (usage_code_max_change_yearly_pct < -.1),
    crit_startend_change = (usage_code_startend_change_pct > .3) | (usage_code_startend_change_pct < -.3)
    ) |>
  filter((crit_yearly_volume & crit_yearly_change) | (crit_yearly_volume & crit_startend_change)) |>
  select(
    end_date,
    snomed_concept_id,
    usage,
    usage_codelist_sum_yearly,
    usage_codelist_yearly_pct,
    usage_codelist_max_yearly_pct,
    usage_code_change_yearly,
    usage_code_change_yearly_pct,
    usage_code_max_change_yearly_pct,
    usage_code_startend_change_pct
    ) |> 
  ungroup()

change_selected_snomed_code_usage |> 
  mutate(end_date = paste0(year(end_date))) |> 
  gt() |>
  cols_hide(c(usage_codelist_max_yearly_pct, usage_code_max_change_yearly_pct, usage_codelist_sum_yearly)) |> 
  cols_label(
    end_date = "Date",
    snomed_concept_id = "SNOMED code",
    usage = "Yearly code usage",
    usage_codelist_sum_yearly = "Yearly codelist usage",
    usage_codelist_yearly_pct = "% of yearly codelist usage",
    usage_code_change_yearly = "Yearly code change",
    usage_code_change_yearly_pct = "Yearly % change",
    usage_code_startend_change_pct = "Start end % change",
  ) |>
  # cols_width(
  #   snomed_concept_id ~ px(160),
  #   description ~ px(280),
  #   active_date_range ~ px(125),
  #   sum_usage_22to23 ~ px(100),
  #   pct_usage_22to23 ~ px(65)
  # ) |>
  fmt_percent(
    columns = c(
      usage_codelist_yearly_pct,
      usage_codelist_max_yearly_pct,
      usage_code_change_yearly_pct,
      usage_code_startend_change_pct
      ),
    decimals = 1
  ) |>
  opt_interactive(
    use_filters = TRUE,
    use_highlight = TRUE,
    use_compact_mode = TRUE,
    use_resizers= TRUE,
    use_page_size_select = TRUE
    ) |>
  sub_missing(
  columns = everything(),
  rows = everything(),
  missing_text = "---"
)

```

```{r}
#| label: fig1-change
#| fig-cap: "Figure X. CHANGE CHANGE CHANGE" 
#| fig-width: 8
#| fig-height: 4

change_selected_snomed_codes <- change_selected_snomed_code_usage |> 
  pull(snomed_concept_id) |> 
  unique()

plot_change_codelist <- snomed_code_usage |> 
  left_join(snomed_code_dict_short) |> 
  filter(snomed_concept_id %in% change_selected_snomed_codes) |> 
  plot_code_usage(
    date = end_date,
    code_usage = usage,
    colour = snomed_concept_id_desc
    ) +
  guides(color = "none")

plotly::ggplotly(plot_change_codelist)
```

### Delivery

```{r}
#| label: change2
#| tbl-cap: Codes from 'pregnancy_delivery_snomed_reviewed_2' with detected changes between 1st Aug 2011 and 31 Jul 2023


# Select data for one codelist
selected_codelist <- pregnancy_codelists |> 
  filter(codelist == "pregnancy_delivery_snomed_reviewed_2")

# Get list of codes from codelist that were not found in GP records
selected_unused_codes <- selected_codelist |> 
  filter(!code %in% used_snomed_concept_ids) |> 
  pull(code)

# Select data for all codes from codelist that were found in GP records
selected_snomed_code_usage <- snomed_code_usage |>
  filter(snomed_concept_id %in% selected_codelist$code)

selected_snomed_code_usage_earliest <- selected_snomed_code_usage |>
  select(start_date, snomed_concept_id, usage) |> 
  slice_min(start_date) |> 
  select(snomed_concept_id, earliest_usage = usage)

selected_snomed_code_latests <- selected_snomed_code_usage |>
  select(start_date, snomed_concept_id, usage) |> 
  slice_max(start_date) |> 
  select(snomed_concept_id, latests_usage = usage)

change_selected_snomed_code_usage <- selected_snomed_code_usage |>
  left_join(selected_snomed_code_usage_earliest) |> 
  left_join(selected_snomed_code_latests) |>
  arrange(snomed_concept_id, start_date) |>
  group_by(start_date) |>
  mutate(usage_codelist_sum_yearly = sum(usage, na.rm = TRUE)) |>
  ungroup() |>
  group_by(snomed_concept_id) |>
  mutate(
    usage_codelist_yearly_pct = usage / usage_codelist_sum_yearly,
    usage_codelist_max_yearly_pct = max(usage_codelist_yearly_pct, na.rm = TRUE),
    usage_code_change_yearly = usage - lag(usage),
    usage_code_change_yearly_pct = usage_code_change_yearly / usage,
    usage_code_max_change_yearly_pct = max(usage_code_change_yearly_pct, na.rm = TRUE),
    usage_code_startend_change_pct = latests_usage / earliest_usage
  ) |>
  mutate(
    crit_yearly_volume = usage_codelist_max_yearly_pct > .05,
    crit_yearly_change = (usage_code_max_change_yearly_pct > .1) | (usage_code_max_change_yearly_pct < -.1),
    crit_startend_change = (usage_code_startend_change_pct > .3) | (usage_code_startend_change_pct < -.3)
    ) |>
  filter((crit_yearly_volume & crit_yearly_change) | (crit_yearly_volume & crit_startend_change)) |>
  select(
    end_date,
    snomed_concept_id,
    usage,
    usage_codelist_sum_yearly,
    usage_codelist_yearly_pct,
    usage_codelist_max_yearly_pct,
    usage_code_change_yearly,
    usage_code_change_yearly_pct,
    usage_code_max_change_yearly_pct,
    usage_code_startend_change_pct
    ) |> 
  ungroup()

change_selected_snomed_code_usage |> 
  mutate(end_date = paste0(year(end_date))) |> 
  gt() |>
  cols_hide(c(usage_codelist_max_yearly_pct, usage_code_max_change_yearly_pct, usage_codelist_sum_yearly)) |> 
  cols_label(
    end_date = "Date",
    snomed_concept_id = "SNOMED code",
    usage = "Yearly code usage",
    usage_codelist_sum_yearly = "Yearly codelist usage",
    usage_codelist_yearly_pct = "% of yearly codelist usage",
    usage_code_change_yearly = "Yearly code change",
    usage_code_change_yearly_pct = "Yearly % change",
    usage_code_startend_change_pct = "Start end % change",
  ) |>
  # cols_width(
  #   snomed_concept_id ~ px(160),
  #   description ~ px(280),
  #   active_date_range ~ px(125),
  #   sum_usage_22to23 ~ px(100),
  #   pct_usage_22to23 ~ px(65)
  # ) |>
  fmt_percent(
    columns = c(
      usage_codelist_yearly_pct,
      usage_codelist_max_yearly_pct,
      usage_code_change_yearly_pct,
      usage_code_startend_change_pct
      ),
    decimals = 1
  ) |>
  opt_interactive(
    use_filters = TRUE,
    use_highlight = TRUE,
    use_compact_mode = TRUE,
    use_resizers= TRUE,
    use_page_size_select = TRUE
    ) |>
  sub_missing(
  columns = everything(),
  rows = everything(),
  missing_text = "---"
)

```

```{r}
#| label: fig2-change
#| fig-cap: "Figure X. CHANGE CHANGE CHANGE" 
#| fig-width: 8
#| fig-height: 4

change_selected_snomed_codes <- change_selected_snomed_code_usage |> 
  pull(snomed_concept_id) |> 
  unique()

plot_change_codelist <- snomed_code_usage |> 
  left_join(snomed_code_dict_short) |> 
  filter(snomed_concept_id %in% change_selected_snomed_codes) |> 
  plot_code_usage(
    date = end_date,
    code_usage = usage,
    colour = snomed_concept_id_desc
    ) +
  guides(color = "none")

plotly::ggplotly(plot_change_codelist)
```

### Post-delivery Antenatal

```{r}
#| label: change3
#| tbl-cap: Codes from 'pregnancy_postdel_antenatal_snomed' with detected changes between 1st Aug 2011 and 31 Jul 2023

# Select data for one codelist
selected_codelist <- pregnancy_codelists |> 
  filter(codelist == "pregnancy_postdel_antenatal_snomed")

# Get list of codes from codelist that were not found in GP records
selected_unused_codes <- selected_codelist |> 
  filter(!code %in% used_snomed_concept_ids) |> 
  pull(code)

# Select data for all codes from codelist that were found in GP records
selected_snomed_code_usage <- snomed_code_usage |>
  filter(snomed_concept_id %in% selected_codelist$code)

selected_snomed_code_usage_earliest <- selected_snomed_code_usage |>
  select(start_date, snomed_concept_id, usage) |> 
  slice_min(start_date) |> 
  select(snomed_concept_id, earliest_usage = usage)

selected_snomed_code_latests <- selected_snomed_code_usage |>
  select(start_date, snomed_concept_id, usage) |> 
  slice_max(start_date) |> 
  select(snomed_concept_id, latests_usage = usage)

change_selected_snomed_code_usage <- selected_snomed_code_usage |>
  left_join(selected_snomed_code_usage_earliest) |> 
  left_join(selected_snomed_code_latests) |>
  arrange(snomed_concept_id, start_date) |>
  group_by(start_date) |>
  mutate(usage_codelist_sum_yearly = sum(usage, na.rm = TRUE)) |>
  ungroup() |>
  group_by(snomed_concept_id) |>
  mutate(
    usage_codelist_yearly_pct = usage / usage_codelist_sum_yearly,
    usage_codelist_max_yearly_pct = max(usage_codelist_yearly_pct, na.rm = TRUE),
    usage_code_change_yearly = usage - lag(usage),
    usage_code_change_yearly_pct = usage_code_change_yearly / usage,
    usage_code_max_change_yearly_pct = max(usage_code_change_yearly_pct, na.rm = TRUE),
    usage_code_startend_change_pct = latests_usage / earliest_usage
  ) |>
  mutate(
    crit_yearly_volume = usage_codelist_max_yearly_pct > .05,
    crit_yearly_change = (usage_code_max_change_yearly_pct > .1) | (usage_code_max_change_yearly_pct < -.1),
    crit_startend_change = (usage_code_startend_change_pct > .3) | (usage_code_startend_change_pct < -.3)
    ) |>
  filter((crit_yearly_volume & crit_yearly_change) | (crit_yearly_volume & crit_startend_change)) |>
  select(
    end_date,
    snomed_concept_id,
    usage,
    usage_codelist_sum_yearly,
    usage_codelist_yearly_pct,
    usage_codelist_max_yearly_pct,
    usage_code_change_yearly,
    usage_code_change_yearly_pct,
    usage_code_max_change_yearly_pct,
    usage_code_startend_change_pct
    ) |> 
  ungroup()

change_selected_snomed_code_usage |> 
  mutate(end_date = paste0(year(end_date))) |> 
  gt() |>
  cols_hide(c(usage_codelist_max_yearly_pct, usage_code_max_change_yearly_pct, usage_codelist_sum_yearly)) |> 
  cols_label(
    end_date = "Date",
    snomed_concept_id = "SNOMED code",
    usage = "Yearly code usage",
    usage_codelist_sum_yearly = "Yearly codelist usage",
    usage_codelist_yearly_pct = "% of yearly codelist usage",
    usage_code_change_yearly = "Yearly code change",
    usage_code_change_yearly_pct = "Yearly % change",
    usage_code_startend_change_pct = "Start end % change",
  ) |>
  # cols_width(
  #   snomed_concept_id ~ px(160),
  #   description ~ px(280),
  #   active_date_range ~ px(125),
  #   sum_usage_22to23 ~ px(100),
  #   pct_usage_22to23 ~ px(65)
  # ) |>
  fmt_percent(
    columns = c(
      usage_codelist_yearly_pct,
      usage_codelist_max_yearly_pct,
      usage_code_change_yearly_pct,
      usage_code_startend_change_pct
      ),
    decimals = 1
  ) |>
  opt_interactive(
    use_filters = TRUE,
    use_highlight = TRUE,
    use_compact_mode = TRUE,
    use_resizers= TRUE,
    use_page_size_select = TRUE
    ) |>
  sub_missing(
  columns = everything(),
  rows = everything(),
  missing_text = "---"
)

```

```{r}
#| label: fig3-change
#| fig-cap: "Figure X. CHANGE CHANGE CHANGE" 
#| fig-width: 8
#| fig-height: 4

change_selected_snomed_codes <- change_selected_snomed_code_usage |> 
  pull(snomed_concept_id) |> 
  unique()

plot_change_codelist <- snomed_code_usage |> 
  left_join(snomed_code_dict_short) |> 
  filter(snomed_concept_id %in% change_selected_snomed_codes) |> 
  plot_code_usage(
    date = end_date,
    code_usage = usage,
    colour = snomed_concept_id_desc
    ) +
  guides(color = "none")

plotly::ggplotly(plot_change_codelist)
```

## Changes in clinical guidance

### Antenatal

### Delivery

### Post-delivery Antenatal

# Discussion

# References
